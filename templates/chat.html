<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Disaster Response Chat</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/css/bootstrap.min.css" rel="stylesheet">
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
    <link rel="stylesheet" href="/src/chat.css">
    
</head>
<body>    <div id="chat-icon">
    <i class="fas fa-comment"></i>
</div>
    <div id="chat" class="bg-dark ">
        <div id="header" class="bg-primary text-white p-3">
            <h2 id="disaster-response-chat" class="mb-0">Disaster Response Chat</h2>
        </div>

        <div id="messages"></div>

        <div id="input-area" class="p-3 border-top">
            <div class="input-group">
                <input type="text" id="message-input" class="form-control" placeholder="Type a message...">
                <button class="btn btn-outline-secondary" type="button" id="file-button">
                    <i class="fas fa-paperclip"></i>
                </button>
                <button class="btn btn-outline-secondary" type="button" id="voice-button">
                    <i class="fas fa-microphone"></i>
                </button>
                <button class="btn btn-outline-secondary" type="button" id="location-button">
                    <i class="fas fa-map-marker-alt"></i>
                </button>
                <button class="btn btn-primary" type="button" id="send-button">Send</button>
            </div>
            <input type="file" id="file-input" style="display: none" accept="image/*,video/*">
        </div>
    </div>

    <!-- Username Modal -->
    <div id="username-modal" class="modal fade" tabindex="-1" aria-hidden="true" data-bs-backdrop="static" data-bs-keyboard="false">
        <div class="modal-dialog modal-dialog-centered">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title">Join Chat</h5>
                </div>
                <div class="modal-body">
                    <div class="mb-3">
                        <label for="username-input" class="form-label">Enter your name</label>
                        <input type="text" class="form-control" id="username-input" required>
                    </div>
                    <button class="btn btn-primary w-100" id="join-button">Join Chat</button>
                </div>
            </div>
        </div>
    </div>

    <!-- Image Modal -->
    <div id="imageModal" class="image-modal">
        <span class="close-modal">&times;</span>
        <img id="modalImage">
    </div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/js/bootstrap.bundle.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/socket.io/4.0.1/socket.io.js"></script>
    <script>
        let socket;
        let username;
        let mediaRecorder;
        let audioChunks = [];

        document.addEventListener('DOMContentLoaded', () => {
            const modal = new bootstrap.Modal(document.getElementById('username-modal'));
            modal.show();

            document.getElementById('join-button').addEventListener('click', () => {
                username = document.getElementById('username-input').value.trim();
                if (username) {
                    modal.hide();
                    initializeChat();
                }
            });

            // Image modal handling
            const imageModal = document.getElementById('imageModal');
            const modalImage = document.getElementById('modalImage');
            const closeModal = document.querySelector('.close-modal');

            closeModal.onclick = function() {
                imageModal.style.display = "none";
            }

            window.onclick = function(event) {
                if (event.target == imageModal) {
                    imageModal.style.display = "none";
                }
            }
        });

        function initializeChat() {
            socket = io();
           
            socket.on('connect', () => {
                console.log('Connected to server');
            });

            socket.on('chat_history', (messages) => {
                const messagesDiv = document.getElementById('messages');
                messagesDiv.innerHTML = '';
                messages.forEach(displayMessage);
            });

            socket.on('new_message', displayMessage);

            socket.on('message_deleted', (data) => {
                const messageElement = document.getElementById(data.messageId);
                if (messageElement) {
                    messageElement.remove();
                }
            });

            document.getElementById('message-input').addEventListener('keypress', (e) => {
                if (e.key === 'Enter') {
                    sendMessage();
                }
            });

            document.getElementById('send-button').addEventListener('click', sendMessage);
            document.getElementById('file-button').addEventListener('click', () => {
                document.getElementById('file-input').click();
            });

            document.getElementById('file-input').addEventListener('change', uploadFile);
            document.getElementById('voice-button').addEventListener('click', toggleVoiceRecording);
            document.getElementById('location-button').addEventListener('click', shareLocation);
        }

        function getFileType(filename) {
            const ext = filename.split('.').pop().toLowerCase();
            const imageTypes = ['jpg', 'jpeg', 'png', 'gif', 'bmp'];
            const videoTypes = ['mp4', 'webm', 'ogg'];
           
            if (imageTypes.includes(ext)) return 'image';
            if (videoTypes.includes(ext)) return 'video';
            return 'other';
        }

        function showImageModal(src) {
            const imageModal = document.getElementById('imageModal');
            const modalImage = document.getElementById('modalImage');
            modalImage.src = src;
            imageModal.style.display = "block";
        }

        function displayMessage(message) {
            const messagesDiv = document.getElementById('messages');
            const messageDiv = document.createElement('div');
            messageDiv.id = message.id;
            messageDiv.className = `message ${message.user === username ? 'message-own' : 'message-other'}`;

            let content = '';
            if (message.type === 'text') {
                content = `<div>${message.text}</div>`;
            } else if (message.type === 'file') {
                const fileType = getFileType(message.originalFilename);
                if (fileType === 'image') {
                    content = `
                        <div class="media-content">
                            <img src="/uploads/${message.filename}" alt="Image" onclick="showImageModal('/uploads/${message.filename}')">
                        </div>`;
                } else if (fileType === 'video') {
                    content = `
                        <div class="media-content">
                            <video controls>
                                <source src="/uploads/${message.filename}" type="video/mp4">
                                Your browser does not support the video tag.
                            </video>
                        </div>`;
                } else {
                    content = `<div><a href="/uploads/${message.filename}" target="_blank">${message.originalFilename}</a></div>`;
                }
            } else if (message.type === 'voice') {
                content = `
                    <div>
                        <audio controls>
                            <source src="/uploads/${message.filename}" type="audio/wav">
                        </audio>
                    </div>`;
            } else if (message.type === 'location') {
                content = `
                    <div>
                        <a href="https://www.google.com/maps?q=${message.latitude},${message.longitude}" target="_blank">
                            View Location
                        </a>
                    </div>`;
            }

            messageDiv.innerHTML = `
                ${content}
                <div class="timestamp">
                    ${message.user} - ${message.timestamp}
                    ${message.user === username ?
                        `<button class="btn btn-sm btn-link text-danger" onclick="deleteMessage('${message.id}')">
                            <i class="fas fa-trash"></i>
                        </button>` : ''}
                </div>`;

            messagesDiv.appendChild(messageDiv);
            messagesDiv.scrollTop = messagesDiv.scrollHeight;
        }

        function sendMessage() {
            const input = document.getElementById('message-input');
            const message = input.value.trim();
           
            if (message) {
                socket.emit('send_message', {
                    username: username,
                    message: message
                });
                input.value = '';
            }
        }

        function uploadFile(event) {
            const file = event.target.files[0];
            if (file) {
                const formData = new FormData();
                formData.append('file', file);
                formData.append('username', username);

                fetch('/upload_file', {
                    method: 'POST',
                    body: formData
                })
                .then(response => response.json())
                .then(data => {
                    socket.emit('send_file', data);
                });
               
                // Reset file input
                event.target.value = '';
            }
        }

        function toggleVoiceRecording() {
            if (!mediaRecorder || mediaRecorder.state === 'inactive') {
                navigator.mediaDevices.getUserMedia({ audio: true })
                    .then(stream => {
                        mediaRecorder = new MediaRecorder(stream);
                        audioChunks = [];

                        mediaRecorder.addEventListener('dataavailable', event => {
                            audioChunks.push(event.data);
                        });

                        mediaRecorder.addEventListener('stop', () => {
                            const audioBlob = new Blob(audioChunks);
                            const formData = new FormData();
                            formData.append('voice', audioBlob, 'voice.wav');
                            formData.append('username', username);

                            fetch('/upload_voice', {
                                method: 'POST',
                                body: formData
                            })
                            .then(response => response.json())
                            .then(data => {
                                socket.emit('send_voice', data);
                            });
                        });

                        mediaRecorder.start();
                        document.getElementById('voice-button').classList.add('btn-danger');
                    });
            } else {
                mediaRecorder.stop();
                document.getElementById('voice-button').classList.remove('btn-danger');
            }
        }

        function shareLocation() {
            if (navigator.geolocation) {
                navigator.geolocation.getCurrentPosition(position => {
                    socket.emit('send_location', {
                        username: username,
                        latitude: position.coords.latitude,
                        longitude: position.coords.longitude
                    });
                });
            }
        }

        function deleteMessage(messageId) {
            socket.emit('delete_message', { messageId: messageId });
        }
        const chatIcon = document.getElementById('chat-icon');
        const chatBox = document.getElementById('chat');

        chatIcon.addEventListener('click', () => {
            if (chatBox.style.display === 'none' || chatBox.style.display === '') {
                chatBox.style.display = 'flex';
            } else {
                chatBox.style.display = 'none';
            }
        });

    </script>
</body>
</html>